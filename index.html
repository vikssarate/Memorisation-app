<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Memorisation & Spaced Repetition ‚Äì Subject ‚Üí Topic ‚Üí Chunks</title>
<style>
:root{
  --bg:#0f1220; --card:#181c2f; --ink:#eef1ff; --muted:#9aa3c7; --line:#2a3052; --accent:#6ca8ff;
  --good:#79e1a7; --warn:#ffd166; --bad:#ff8080; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.25);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
header,footer{padding:10px 14px;display:flex;align-items:center;gap:10px}
header{justify-content:space-between;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.04),transparent)}
h1{margin:0;font-size:18px;font-weight:600}
small.muted{color:var(--muted)}
.wrap{max-width:1200px;margin:0 auto;padding:12px;display:grid;gap:12px;grid-template-columns:260px 1fr}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
.pad{padding:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.input{background:#0e1422;border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:10px 12px}
.btn{background:var(--accent);color:#06111f;border:0;border-radius:10px;padding:10px 12px;font-weight:600}
.btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--line)}
.btn.small{padding:6px 10px;border-radius:8px}
.btn.good{background:var(--good)}
.btn.warn{background:var(--warn)}
.btn.bad{background:var(--bad)}
hr.sep{border:0;border-top:1px dashed var(--line);margin:10px 0}
.sidebar ul{list-style:none;margin:0;padding:0}
.sidebar li{margin:4px 0}
.item{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px;border-radius:10px}
.item.active{background:#101832;border:1px solid var(--line)}
.item .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tag{font-size:12px;color:#0b1424;background:#a0b8ff1a;border:1px solid #3a5bd4;border-radius:999px;padding:2px 8px}
.kv{display:grid;grid-template-columns:140px 1fr;gap:6px 12px;align-items:center}
.grid{display:grid;gap:10px}
.grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
.grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
.grid.cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}
.box{border:1px solid var(--line);border-radius:10px;padding:10px}
h2{margin:4px 0 8px 0;font-size:16px}
h3{margin:4px 0 6px 0;font-size:14px;color:var(--muted)}
label.cb{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:10px;min-width:44px;justify-content:center}
label.cb input{width:18px;height:18px}
table{width:100%;border-collapse:separate;border-spacing:0 8px}
td,th{padding:8px 10px;text-align:left}
tr{background:#0e1422;border:1px solid var(--line)}
tr.overdue{outline:2px solid var(--bad)}
tr.today{outline:2px solid var(--accent)}
.badge{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted)}
.smallmuted{font-size:12px;color:var(--muted)}
@media (max-width:900px){ .wrap{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="row">
    <h1>Memorisation + Spaced Repetition</h1>
    <small class="muted">3√ó/day √ó 3 days ‚Üí Week Box ‚Üí 1/day ‚Üí Spaced: 1,2,3,4,8,16,28 days</small>
  </div>
  <div class="row">
    <button class="btn small" id="exportBtn">Export JSON</button>
    <label class="btn small ghost" for="importFile">Import JSON</label>
    <input id="importFile" type="file" accept="application/json" hidden />
    <button class="btn small good" id="newSubjectBtn">+ Subject</button>
  </div>
</header>

<div class="wrap">
  <!-- LEFT: tree -->
  <aside class="card pad sidebar" id="tree"></aside>

  <!-- RIGHT: main -->
  <main class="grid">
    <section class="card pad" id="dashboard">
      <h2>Today</h2>
      <div class="row">
        <span class="badge" id="countsIntense">Intense due: 0</span>
        <span class="badge" id="countsWeek">Week Box due: 0</span>
        <span class="badge" id="countsSpaced">Spaced due: 0</span>
        <span class="badge" id="todayStr"></span>
      </div>
      <hr class="sep" />
      <div id="todayList"></div>
    </section>

    <section class="card pad" id="topicView">
      <h2 id="topicTitle">Current Topic</h2>
      <div id="topicControls" class="row"></div>
      <hr class="sep" />
      <div id="chunks"></div>
    </section>

    <section class="card pad" id="spacedView">
      <h2>Spaced Repetition (by Topic)</h2>
      <div id="spacedTable"></div>
    </section>
  </main>
</div>

<footer class="row" style="justify-content:center;color:var(--muted)">
  Built for quick iPad/GitHub workflows ‚Ä¢ Saves locally ‚Ä¢ No login
</footer>

<script>
/* -------------------- Utilities -------------------- */
const $ = (s, d=document)=>d.querySelector(s);
const $$ = (s, d=document)=>[...d.querySelectorAll(s)];
const uid = ()=>crypto.randomUUID();
const todayISO = ()=> new Date().toISOString().slice(0,10);
const addDays = (iso, n)=>{
  const d = new Date(iso+"T00:00:00"); d.setDate(d.getDate()+n);
  return d.toISOString().slice(0,10);
};
const cmpISO = (a,b)=> (a<b?-1:a>b?1:0);
const niceDate = iso => new Date(iso+"T00:00:00").toLocaleDateString();

/* -------------------- Data Model -------------------- */
const STORAGE_KEY = "memobox_v1";
const DEFAULT_INTERVALS = [1,2,3,4,8,16,28];

let db = load() || seed();

function seed(){
  const s1 = {id:uid(), name:"Sample Subject", topics:[
    {id:uid(), name:"Sample Topic", spacedActive:false, spacedRoundIndex:0, chunks:[
      mkChunk("Chunk 1"), mkChunk("Chunk 2"), mkChunk("Chunk 3")
    ]}
  ]};
  return {subjects:[s1], current:{subjectId:s1.id, topicId:s1.topics[0].id}};
}
function mkChunk(name){
  return {
    id:uid(), name,
    phase:"intense",                         // intense ‚Üí weekbox ‚Üí spaced
    intense:{grid:Array.from({length:3},()=>Array(3).fill(false))}, // 3√ó3
    weekbox:{last:"", next:todayISO()},
    spaced:{index:0, last:"", next:""},     // index=0..6; next due date
    history:[]
  };
}
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||""); }catch{ return null } }

/* -------------------- Tree Rendering -------------------- */
function renderTree(){
  const el = $("#tree"); el.innerHTML = "";
  const h = document.createElement("div");
  h.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">Subjects</h2>
      <button class="btn small ghost" id="newTopicBtn">+ Topic</button>
    </div>
    <hr class="sep" />
  `;
  el.appendChild(h);

  const ul = document.createElement("ul");
  db.subjects.forEach(sub=>{
    const liS = document.createElement("li");
    const head = document.createElement("div");
    head.className = "item";
    head.innerHTML = `
      <div class="name">${sub.name}</div>
      <div class="row">
        <span class="tag">${sub.topics.length} topics</span>
        <button class="btn small ghost" data-act="ren-sub" data-id="${sub.id}">‚úèÔ∏è</button>
        <button class="btn small bad" data-act="del-sub" data-id="${sub.id}">üóë</button>
      </div>
    `;
    liS.appendChild(head);

    const ulT = document.createElement("ul");
    sub.topics.forEach(t=>{
      const liT = document.createElement("li");
      const active = (db.current.subjectId===sub.id && db.current.topicId===t.id) ? "active" : "";
      liT.innerHTML = `
        <div class="item ${active}">
          <div class="name">‚Ü≥ ${t.name}</div>
          <div class="row">
            <span class="tag">${t.chunks.length} chunks</span>
            <button class="btn small ghost" data-act="ren-topic" data-id="${t.id}">‚úèÔ∏è</button>
            <button class="btn small bad" data-act="del-topic" data-id="${t.id}">üóë</button>
            <button class="btn small" data-act="open-topic" data-sid="${sub.id}" data-tid="${t.id}">Open</button>
          </div>
        </div>
      `;
      ulT.appendChild(liT);
    });
    liS.appendChild(ulT);
    ul.appendChild(liS);
  });
  el.appendChild(ul);

  // handlers
  el.onclick = (e)=>{
    const btn = e.target.closest("button"); if(!btn) return;
    const act = btn.dataset.act;
    if(act==="ren-sub"){
      const s = getSubject(btn.dataset.id);
      const name = prompt("Rename subject:", s.name); if(name){ s.name=name; save(); renderAll(); }
    }else if(act==="del-sub"){
      if(confirm("Delete subject and all its topics?")){
        db.subjects = db.subjects.filter(s=>s.id!==btn.dataset.id);
        save(); renderAll();
      }
    }else if(act==="ren-topic"){
      const t = getTopic(btn.dataset.id);
      const name = prompt("Rename topic:", t.name); if(name){ t.name=name; save(); renderAll(); }
    }else if(act==="del-topic"){
      if(confirm("Delete topic and its chunks?")){
        const {subject} = findTopic(btn.dataset.id);
        subject.topics = subject.topics.filter(t=>t.id!==btn.dataset.id);
        save(); renderAll();
      }
    }else if(act==="open-topic"){
      db.current.subjectId = btn.dataset.sid;
      db.current.topicId = btn.dataset.tid;
      save(); renderAll();
    }
  };
}
$("#newSubjectBtn").onclick = ()=>{
  const name = prompt("Subject name"); if(!name) return;
  db.subjects.push({id:uid(), name, topics:[]});
  save(); renderAll();
};
$("#newTopicBtn").onclick = ()=>{
  const s = getCurrentSubject(); if(!s){ alert("Create a subject first."); return; }
  const name = prompt("Topic name"); if(!name) return;
  s.topics.push({id:uid(), name, spacedActive:false, spacedRoundIndex:0, chunks:[]});
  save(); renderAll();
};

/* -------------------- Helpers to find -------------------- */
function getSubject(id){ return db.subjects.find(x=>x.id===id); }
function getCurrentSubject(){ return getSubject(db.current.subjectId); }
function findTopic(topicId){
  for(const subject of db.subjects){
    const topic = subject.topics.find(t=>t.id===topicId);
    if(topic) return {subject, topic};
  }
  return {subject:null, topic:null};
}
function getCurrentTopic(){ return findTopic(db.current.topicId).topic; }

/* -------------------- Topic View -------------------- */
function renderTopic(){
  const t = getCurrentTopic();
  const s = getCurrentSubject();
  const title = $("#topicTitle");
  if(!t){ title.textContent = "No topic selected"; $("#chunks").innerHTML=""; $("#topicControls").innerHTML=""; return; }

  title.textContent = `${s.name} ‚Üí ${t.name}`;
  const ctrl = $("#topicControls");
  ctrl.innerHTML = `
    <input id="newChunkName" class="input" placeholder="New chunk name" />
    <button class="btn" id="addChunkBtn">Add Chunk</button>
    <button class="btn ghost" id="renameTopicBtn">Rename</button>
    <button class="btn bad" id="clearDoneBtn">Delete Finished (confirm)</button>
  `;
  $("#addChunkBtn").onclick = ()=>{
    const name = $("#newChunkName").value.trim();
    if(!name) return;
    t.chunks.push(mkChunk(name));
    save(); renderAll();
  };
  $("#renameTopicBtn").onclick = ()=>{
    const name = prompt("Rename topic:", t.name); if(name){ t.name=name; save(); renderAll(); }
  };
  $("#clearDoneBtn").onclick = ()=>{
    if(confirm("Delete chunks that finished all spaced rounds?")){
      t.chunks = t.chunks.filter(c=>!(c.phase==="spaced" && c.spaced.index>=DEFAULT_INTERVALS.length));
      save(); renderAll();
    }
  };

  // list chunks
  const host = $("#chunks");
  host.innerHTML = "";
  if(!t.chunks.length){
    host.innerHTML = `<div class="smallmuted">Add chunks to begin the 3√ó3 intense phase.</div>`;
    return;
  }
  t.chunks.forEach(c=>{
    const box = document.createElement("div");
    box.className = "box";
    box.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <h3>${c.name}</h3>
        <div class="row">
          <span class="tag">${c.phase}</span>
          <button class="btn small ghost" data-act="rename" data-id="${c.id}">‚úèÔ∏è</button>
          <button class="btn small bad" data-act="delete" data-id="${c.id}">üóë</button>
        </div>
      </div>
      <div>${renderChunkPhase(c)}</div>
    `;
    // wire
    box.onclick = (e)=>{
      const b = e.target.closest("button"); if(!b) return;
      if(b.dataset.act==="rename"){
        const name = prompt("Rename chunk:", c.name); if(name){ c.name=name; save(); renderAll(); }
      }else if(b.dataset.act==="delete"){
        if(confirm("Delete this chunk?")){
          t.chunks = t.chunks.filter(x=>x.id!==c.id); save(); renderAll();
        }
      }
    };
    host.appendChild(box);
  });

  // WeekBox ‚Üí Spaced activation check
  maybeActivateSpaced(t);
}

/* --- chunk phase UIs --- */
function renderChunkPhase(c){
  if(c.phase==="intense"){
    // 3 days √ó 3 times
    let grid = "";
    for(let d=0; d<3; d++){
      grid += `<div><div class="smallmuted" style="margin:6px 0">Day ${d+1}</div>`;
      for(let r=0; r<3; r++){
        const checked = c.intense.grid[d][r] ? "checked" : "";
        grid += `<label class="cb"><input type="checkbox" data-intense="${c.id}" data-d="${d}" data-r="${r}" ${checked}/>‚úî</label>`;
      }
      grid += `</div>`;
    }
    return `<div class="grid cols-3">${grid}</div>
      <div class="smallmuted" style="margin-top:8px">Mark 3 boxes per day for 3 days. When all 9 are checked, this chunk moves to Week Box (1/day).</div>`;
  }
  if(c.phase==="weekbox"){
    const due = c.weekbox.next || todayISO();
    const dueTxt = (cmpISO(due, todayISO())<=0) ? `<span class="tag" style="border-color:#2a6; color:#9f9">due today</span>` : `<span class="tag">${niceDate(due)}</span>`;
    return `
      <div class="row">
        <button class="btn small good" data-weekdone="${c.id}">‚úì Review today</button>
        <div class="smallmuted">Next due: ${dueTxt}</div>
      </div>
      <div class="smallmuted">Week Box = one review per day until ALL chunks of this topic reach Week Box. Then topic enters spaced repetition.</div>
    `;
  }
  // spaced
  const idx = c.spaced.index;
  const finished = idx>=DEFAULT_INTERVALS.length;
  const label = finished ? "‚úÖ completed rounds" : `${DEFAULT_INTERVALS[idx]}D round`;
  const due = c.spaced.next || todayISO();
  const dueStr = finished ? "‚Äî" : niceDate(due);
  return `
    <div class="row">
      ${finished ? `<span class="tag">28D loop complete</span>` :
        `<button class="btn small good" data-spaced="${c.id}">‚úì Review (${label})</button>`}
      <div class="smallmuted">Next due: ${finished? "‚Äî" : dueStr}</div>
    </div>
  `;
}

/* -------------------- Handlers for checkboxes -------------------- */
document.addEventListener("change",(e)=>{
  const inp = e.target;
  // intense checkbox
  if(inp.matches("input[type=checkbox][data-intense]")){
    const id = inp.dataset.intense; const d = +inp.dataset.d; const r = +inp.dataset.r;
    const {topic, chunk} = getChunk(id);
    chunk.intense.grid[d][r] = inp.checked;
    // if all 9 checked ‚Üí move to weekbox
    const done = chunk.intense.grid.flat().every(Boolean);
    if(done){
      chunk.phase="weekbox";
      chunk.weekbox.last = "";
      chunk.weekbox.next = todayISO();
    }
    save(); renderAll();
  }
});

document.addEventListener("click",(e)=>{
  const b = e.target.closest("button"); if(!b) return;
  // week box done today
  if(b.dataset.weekdone){
    const {chunk} = getChunk(b.dataset.weekdone);
    const today = todayISO();
    if(chunk.weekbox.last===today){ alert("Already done today."); return; }
    chunk.weekbox.last = today;
    chunk.weekbox.next = addDays(today,1);
    chunk.history.push({t:Date.now(), phase:"weekbox"});
    save(); renderAll();
  }
  // spaced done
  if(b.dataset.spaced){
    const {chunk} = getChunk(b.dataset.spaced);
    const idx = chunk.spaced.index;
    if(idx>=DEFAULT_INTERVALS.length){
      // keep at 28D (repeat) if you want; here we stop incrementing
      return;
    }
    const today = todayISO();
    chunk.spaced.last = today;
    const gap = DEFAULT_INTERVALS[idx];
    chunk.spaced.next = addDays(today, gap);
    chunk.history.push({t:Date.now(), phase:`spaced_${gap}D`});
    chunk.spaced.index = Math.min(idx+1, DEFAULT_INTERVALS.length); // after 28D, treated as finished
    save(); renderAll();
  }
});

/* find chunk */
function getChunk(id){
  for(const subject of db.subjects){
    for(const topic of subject.topics){
      const chunk = topic.chunks.find(c=>c.id===id);
      if(chunk) return {subject, topic, chunk};
    }
  }
  return {};
}

/* -------------------- Topic state transitions -------------------- */
function maybeActivateSpaced(topic){
  if(topic.spacedActive) return;
  const allInWeek = topic.chunks.length>0 && topic.chunks.every(c=>c.phase!=="intense");
  if(allInWeek){
    topic.spacedActive = true;
    // move all to spaced (start first 1D round as they exit weekbox)
    topic.chunks.forEach(c=>{
      c.phase = "spaced";
      c.spaced.index = 0;
      c.spaced.next = addDays(todayISO(), DEFAULT_INTERVALS[0]); // first due tomorrow if you review today
    });
    topic.spacedRoundIndex = 0;
    save(); renderAll();
  }
}

/* -------------------- Dashboard ("Today") -------------------- */
function renderToday(){
  $("#todayStr").textContent = new Date().toLocaleDateString(undefined,{weekday:"short",year:"numeric",month:"short",day:"numeric"});
  const items = []; let ctI=0, ctW=0, ctS=0;

  db.subjects.forEach(sub=>{
    sub.topics.forEach(t=>{
      t.chunks.forEach(c=>{
        if(c.phase==="intense"){
          // if any box unchecked today? We simply surface chunk in intense list.
          ctI++; items.push({type:"intense", sub, t, c});
        }else if(c.phase==="weekbox"){
          if(!c.weekbox.next || cmpISO(c.weekbox.next, todayISO())<=0){
            ctW++; items.push({type:"weekbox", sub, t, c});
          }
        }else if(c.phase==="spaced"){
          if(c.spaced.index<DEFAULT_INTERVALS.length && (!c.spaced.next || cmpISO(c.spaced.next, todayISO())<=0)){
            ctS++; items.push({type:"spaced", sub, t, c});
          }
        }
      });
    });
  });

  $("#countsIntense").textContent = `Intense due: ${ctI}`;
  $("#countsWeek").textContent = `Week Box due: ${ctW}`;
  $("#countsSpaced").textContent = `Spaced due: ${ctS}`;

  const host = $("#todayList");
  if(items.length===0){ host.innerHTML = `<div class="smallmuted">Nothing due right now. Add chunks or check back tomorrow.</div>`; return; }

  const tbl = document.createElement("table");
  tbl.innerHTML = `<thead>
    <tr style="background:transparent;outline:none">
      <th>Subject</th><th>Topic</th><th>Chunk</th><th>Phase</th><th>Due / Action</th>
    </tr></thead><tbody></tbody>`;
  const tb = tbl.querySelector("tbody");
  items.forEach(x=>{
    const tr = document.createElement("tr");
    let action = "";
    if(x.type==="intense"){
      action = `<span class="smallmuted">Open chunk below to tick 3√ó3 grid</span>`;
      tr.classList.add("today");
    }else if(x.type==="weekbox"){
      action = `<button class="btn small good" data-weekdone="${x.c.id}">‚úì Review today</button>`;
      tr.classList.add("today");
    }else{
      action = `<button class="btn small good" data-spaced="${x.c.id}">‚úì Review (${DEFAULT_INTERVALS[x.c.spaced.index]}D)</button>`;
      tr.classList.add("today");
    }
    tr.innerHTML = `<td>${x.sub.name}</td><td>${x.t.name}</td><td>${x.c.name}</td>
      <td>${x.c.phase}</td><td>${action}</td>`;
    tb.appendChild(tr);
  });
  host.innerHTML=""; host.appendChild(tbl);
}

/* -------------------- Spaced table -------------------- */
function renderSpacedTable(){
  const host = $("#spacedTable"); host.innerHTML = "";
  const rows = [];
  db.subjects.forEach(sub=>{
    sub.topics.forEach(t=>{
      if(!t.chunks.length) return;
      const due = t.chunks.filter(c=>c.phase==="spaced" && c.spaced.index<DEFAULT_INTERVALS.length);
      const finished = t.chunks.filter(c=>c.phase==="spaced" && c.spaced.index>=DEFAULT_INTERVALS.length).length;
      rows.push({sub, t, due:due.length, finished});
    });
  });
  if(!rows.length){ host.innerHTML = `<div class="smallmuted">No topics in spaced repetition yet.</div>`; return; }

  const tbl = document.createElement("table");
  tbl.innerHTML = `<thead>
    <tr style="background:transparent;outline:none">
      <th>Subject</th><th>Topic</th><th>Chunks (spaced due)</th><th>Finished</th>
    </tr></thead><tbody></tbody>`;
  const tb = tbl.querySelector("tbody");
  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.sub.name}</td><td>${r.t.name}</td><td>${r.due}</td><td>${r.finished}</td>`;
    tb.appendChild(tr);
  });
  host.appendChild(tbl);
}

/* -------------------- Export / Import -------------------- */
$("#exportBtn").onclick = ()=>{
  const blob = new Blob([JSON.stringify(db,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `memobox_${todayISO()}.json`;
  a.click();
};
$("#importFile").onchange = async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const text = await f.text();
  try{
    const data = JSON.parse(text);
    if(!data.subjects) throw new Error("Invalid file");
    db = data; save(); renderAll();
    alert("Imported!");
  }catch(err){ alert("Import failed: "+err.message); }
};

/* -------------------- Initial render -------------------- */
function renderAll(){ renderTree(); renderTopic(); renderToday(); renderSpacedTable(); }
renderAll();
</script>
</body>
</html>
